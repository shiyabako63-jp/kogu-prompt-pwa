<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="description" content="古物鑑定（簡易/通常）PWA" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="stylesheet" href="/style.css" />
  <title>古物鑑定 PWA</title>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">鑑</div>
      <div class="brandText">
        <div class="brandTitle">古物鑑定</div>
        <div class="brandSub">画像→モード→（通常のみ入力）→鑑定</div>
      </div>
    </div>
    <button id="btnReset" class="btn btn-ghost" type="button" title="最初から">リセット</button>
  </header>

  <main class="wrap">
    <!-- A: 画像取得 -->
    <section class="card" id="cardPick">
      <h2>1) 画像を用意</h2>
      <p class="muted">最初はここだけ。撮るか選ぶだけでOK。</p>

      <div class="row">
        <button id="btnCamera" class="btn btn-primary" type="button">カメラで撮る</button>
        <button id="btnGallery" class="btn" type="button">画像フォルダ</button>

        <!-- 実際の input は隠してボタンで起動 -->
        <input id="fileCamera" class="hidden" type="file" accept="image/*" capture="environment" multiple />
        <input id="fileGallery" class="hidden" type="file" accept="image/*" multiple />
      </div>

      <div id="pickHint" class="hint">
        複数枚OK。結果は画像ごとに出します（画像同士の関連推測を避けるため）。
      </div>

      <div id="thumbs" class="thumbs" aria-label="選択した画像一覧"></div>

      <div class="row row-right">
        <button id="btnClearImages" class="btn btn-ghost" type="button" disabled>画像を消す</button>
      </div>
    </section>

    <!-- B: モード選択（画像が入ったら出る） -->
    <section class="card hidden" id="cardMode">
      <h2>2) モードを選択</h2>
      <p class="muted">簡易は即鑑定。通常は追加情報を入力できます。</p>

      <div class="row">
        <button id="btnSimple" class="btn btn-primary" type="button">簡易鑑定（すぐ実行）</button>
        <button id="btnNormal" class="btn" type="button">通常鑑定（入力あり）</button>
      </div>

      <div class="divider"></div>

      <details class="details">
        <summary>ヒント（運用）</summary>
        <div class="detailsBody">
          <ul class="list">
            <li>「通常鑑定」は誤認防止向け。刻印・サイズ・動作などがあると精度が上がります。</li>
            <li>画像は自動圧縮して送ります（通信と失敗率対策）。</li>
          </ul>
        </div>
      </details>
    </section>

    <!-- C: 通常鑑定の追加情報（通常選択時のみ表示） -->
    <section class="card hidden" id="cardNormal">
      <h2>3) 追加情報（通常鑑定のみ）</h2>
      <p class="muted">分かる範囲でOK。空欄でも進めます。</p>

      <div class="grid">
        <div class="field">
          <label for="fSize">サイズ（任意）</label>
          <input id="fSize" type="text" placeholder="例：縦20cm×横15cm×高さ10cm / 直径 / 重さ など" />
        </div>

        <div class="field">
          <label for="fMark">刻印・型番・サイン（任意）</label>
          <input id="fMark" type="text" placeholder="例：型番 / 裏刻印 / サイン / ラベルの文字" />
        </div>

        <div class="field">
          <label for="fPower">動作・通電（任意）</label>
          <select id="fPower">
            <option value="">未選択</option>
            <option value="OK">OK</option>
            <option value="NG">NG</option>
            <option value="未確認">未確認</option>
          </select>
        </div>

        <div class="field">
          <label for="fAccessory">付属品（任意）</label>
          <input id="fAccessory" type="text" placeholder="例：箱・説明書・ケーブル・付属パーツ" />
        </div>

        <div class="field full">
          <label for="fCondition">状態メモ（任意）</label>
          <textarea id="fCondition" rows="4" placeholder="例：傷/欠け/汚れ/臭い/ガタつき/割れ/歪み など"></textarea>
        </div>

        <div class="field full">
          <label for="fNote">補足（任意）</label>
          <textarea id="fNote" rows="3" placeholder="例：入手経路、素材、分かること、気になる点"></textarea>
        </div>
      </div>

      <div class="row">
        <button id="btnRunNormal" class="btn btn-primary" type="button">鑑定開始（通常鑑定）</button>
        <button id="btnBackToMode" class="btn btn-ghost" type="button">モード選択へ戻る</button>
      </div>
    </section>

    <!-- 実行中 -->
    <section class="card hidden" id="cardProgress" aria-live="polite">
      <h2>鑑定中</h2>
      <div class="progress">
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <div id="progressTitle" class="progressTitle">送信しています…</div>
          <div id="progressSub" class="muted">画像サイズにより少し時間がかかることがあります。</div>
        </div>
      </div>
      <div class="row row-right">
        <button id="btnCancel" class="btn btn-ghost" type="button">中断</button>
      </div>
    </section>

    <!-- 結果 -->
    <section class="card hidden" id="cardResult">
      <h2>結果</h2>
      <p class="muted">画像ごとの結果です。必要ならコピーできます。</p>

      <div class="row">
        <button id="btnCopyAll" class="btn" type="button">全部コピー</button>
        <button id="btnDownloadAll" class="btn btn-ghost" type="button">TXT保存</button>
      </div>

      <div id="resultList" class="resultList"></div>

      <div class="divider"></div>

      <details class="details">
        <summary>エラーになったとき</summary>
        <div class="detailsBody">
          <ul class="list">
            <li>画像が大きい場合は自動圧縮しますが、失敗するなら枚数を減らして試してください。</li>
            <li>Worker未設定だと <code>/api/appraise</code> で失敗します（次にWorker側を作ります）。</li>
          </ul>
        </div>
      </details>
    </section>

    <!-- フッター -->
    <footer class="footer">
      <div class="muted small">
        ローカルに保存しません（ブラウザ内の一時処理のみ）。<br/>
        実運用ではAPIキーをフロントに置かず、Worker経由でGeminiへ接続します。
      </div>
    </footer>
  </main>

  <script src="/app.js" defer></script>
</body>
</html>
